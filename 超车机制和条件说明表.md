# 自动超车机制和条件说明表

## 一、前置条件检查表

| 序号 | 检查项 | 条件 | 阈值/要求 | 说明 |
|------|--------|------|-----------|------|
| 1 | 系统状态 | 系统已启用且激活 | `enabled == true && active == true` | 必须系统正常运行 |
| 2 | 本车速度 | 速度满足要求 | `≥ 60 km/h (16.67 m/s)` | 低于此速度不触发超车 |
| 3 | 静止状态 | 不在静止状态 | `standstill == false` | 静止时禁止超车 |
| 4 | 道路类型 | 只允许高速或快速路 | `roadcate in [1, 6]` | 1=高速, 6=快速路 |
| 5 | 前车存在 | 前车存在且距离较近 | `lead0 != null && x < 80m && prob ≥ 0.5` | 前车必须存在且置信度高 |
| 6 | 前车最低速度 | 前车速度不低于阈值 | **高速/快速路：≥ 35 km/h**<br>**普通道路：≥ 20 km/h** | 避免堵车误判（方案2） |
| 7 | 前车加速度 | 前车不在加速中 | `lead0.a ≤ 0.5 m/s²` | 前车加速时暂缓超车 |
| 8 | 第二前车 | 第二前车距离足够 | `lead1 == null || lead1.x ≥ 150m` | 确保超车空间 |
| 9 | 弯道检查 | 不在弯道 | `abs(curvature.maxOrientationRate) < 0.02 rad/s` | 弯道禁止超车 |
| 10 | 变道状态 | 系统未在变道中 | `laneChangeState == 0` | 变道中禁止新超车 |
| 11 | 方向盘角度 | 方向盘角度正常 | `abs(steeringAngleDeg) ≤ 15°` | 角度过大禁止超车 |

**说明**：所有前置条件必须**全部满足**才能进入超车流程。

---

## 二、超车需求判断表

| 检查项 | 优先级 | 条件 | 阈值 | 说明 |
|--------|--------|------|------|------|
| **达到巡航速度检查**（方案4） | 1 | 当前速度达到巡航速度比例 | `vEgo / desiredSpeed ≥ 0.95` | 达到95%巡航速度时不触发超车 |
| **远距离超车支持**（方案3） | 2 | 提前超车条件（仅在高速/快速路） | **必须全部满足：**<br>1. 前车速度 ≥ 50 km/h<br>2. 前车速度 ≤ 60% 本车速度<br>3. 速度差 ≥ 20 km/h<br>4. 距离在 30-100 米 | 满足时直接返回true，跳过其他检查 |
| **常规超车条件** | 3 | 前车速度低于限速 | `vLead < speedLimit × 0.9` | 前车接近限速时不超车 |
| | | 速度差或速度比例 | `速度差 ≥ 10 km/h` **或** `前车速度 ≤ 80% 本车速度` | 满足任一条件即可 |
| | | 第二前车速度检查 | `lead1Speed - vEgo ≤ 5 m/s` | 超车道有快车接近时不超车 |

**说明**：按优先级顺序检查，满足任一条件即可触发超车需求判断。

---

## 三、超车可行性评估表

### 3.1 左超车可行性检查

| 序号 | 检查项 | 条件 | 阈值 | 说明 |
|------|--------|------|------|------|
| 1 | 左车道线置信度 | 置信度足够 | `leftLaneProb ≥ 0.7` | 车道线检测必须可靠 |
| 2 | 左车道线类型 | 车道线为虚线 | `leftLaneLine == 0` | 实线不能变道 |
| 3 | 弯道方向 | 不在左弯 | `curvature.maxOrientationRate ≥ 0` | 左弯时禁止左超车 |
| 4 | 左车道宽度 | 车道宽度足够 | `laneWidthLeft ≥ 3.0 m` | 确保有足够空间 |
| 5 | 左盲区 | 盲区无车辆 | `leftBlindspot == false` | 盲区有车禁止超车 |
| 6 | 左侧车辆距离 | 无近距离车辆 | `leadLeft.dRel ≥ 30 m` | 确保安全距离 |
| 7 | 左侧车辆速度 | 无快速接近车辆 | `leadLeft.vRel ≥ -5 m/s` | 避免被快速接近 |

### 3.2 右超车可行性检查

| 序号 | 检查项 | 条件 | 阈值 | 说明 |
|------|--------|------|------|------|
| 1 | 右车道线置信度 | 置信度足够 | `rightLaneProb ≥ 0.7` | 车道线检测必须可靠 |
| 2 | 右车道线类型 | 车道线为虚线 | `rightLaneLine == 0` | 实线不能变道 |
| 3 | 弯道方向 | 不在右弯 | `curvature.maxOrientationRate ≤ 0` | 右弯时禁止右超车 |
| 4 | 右车道宽度 | 车道宽度足够 | `laneWidthRight ≥ 3.0 m` | 确保有足够空间 |
| 5 | 右盲区 | 盲区无车辆 | `rightBlindspot == false` | 盲区有车禁止超车 |
| 6 | 右侧车辆距离 | 无近距离车辆 | `leadRight.dRel ≥ 30 m` | 确保安全距离 |
| 7 | 右侧车辆速度 | 无快速接近车辆 | `leadRight.vRel ≥ -5 m/s` | 避免被快速接近 |

**说明**：
- 左超车和右超车检查逻辑相同，但方向相反
- **优先选择左超车**（符合中国交通规则）
- 所有条件必须**全部满足**才能执行超车

---

## 四、动态冷却机制表（方案1）

| 超车结果 | 基础冷却时间 | 连续失败惩罚 | 道路类型调整 | 最终冷却时间 |
|---------|-------------|-------------|-------------|-------------|
| **成功** | 15 秒 | 无 | 高速/快速路：×0.8<br>普通道路：×1.2 | 高速：12秒<br>普通：18秒 |
| **失败** | 3 秒 | 连续失败>3次：<br>`+min(10秒, 失败次数×2秒)` | 高速/快速路：×0.8<br>普通道路：×1.2 | 高速：2.4秒起<br>普通：3.6秒起 |
| **条件不满足** | 5 秒 | 连续失败>3次：<br>`+min(10秒, 失败次数×2秒)` | 高速/快速路：×0.8<br>普通道路：×1.2 | 高速：4秒起<br>普通：6秒起 |
| **其他** | 8 秒 | 连续失败>3次：<br>`+min(10秒, 失败次数×2秒)` | 高速/快速路：×0.8<br>普通道路：×1.2 | 高速：6.4秒起<br>普通：9.6秒起 |

**说明**：
- 成功后充分冷却，避免频繁超车
- 失败后快速重试，提高成功率
- 连续失败时增加惩罚时间
- 根据道路类型自适应调整

---

## 五、返回原车道条件表（方案5）

| 检查项 | 条件 | 阈值/要求 | 说明 |
|--------|------|-----------|------|
| **车道记忆** | 已记录原车道 | `originalLaneNumber > 0 && netLaneChanges != 0` | 必须有超车记录 |
| **超时检查** | 未超时 | `当前时间 - 开始时间 < 30秒` | 超过30秒自动重置 |
| **完全超越检查** | 目标侧无车或距离很远 | `targetLead == null || !status || dRel > 50m` | 确保已完全超越 |
| | 等待时间 | `等待时间 ≥ 2秒` | 确保完全超越 |
| **返回效率检查** | 速度优势足够 | `目标车道速度 - 当前车道速度 ≥ 8 km/h` | 返回必须有速度优势 |
| **返回安全检查** | 盲区无车辆 | `返回方向盲区 == false` | 盲区检查 |
| | 目标车道无车 | `targetLead == null || !status` | 无车时安全返回 |
| | 目标车道有车但距离安全 | `dRel > 50m` **或**<br>`(vRel > 5 km/h && dRel > 安全距离)` | 有车时需距离安全 |

**说明**：
- 所有条件必须**全部满足**才能返回原车道
- 返回方向：`netLaneChanges > 0` 向右返回，`< 0` 向左返回

---

## 六、关键参数汇总表

### 6.1 速度参数

| 参数名 | 值 | 单位 | 说明 |
|--------|-----|------|------|
| 最小超车速度 | 60 | km/h | 低于此速度不触发超车 |
| 速度差阈值 | 10 | km/h | 常规超车最小速度差 |
| 速度比例阈值 | 0.8 | - | 前车速度/本车速度阈值 |
| 高速前车最低速度 | 35 | km/h | 高速/快速路前车最低速度 |
| 普通前车最低速度 | 20 | km/h | 普通道路前车最低速度 |
| 远距离超车前车最低速度 | 50 | km/h | 远距离超车前车最低速度 |
| 远距离超车最小速度差 | 20 | km/h | 远距离超车最小速度差 |
| 远距离超车速度比例 | 0.6 | - | 前车速度 ≤ 60% 本车速度 |
| 巡航速度比例阈值 | 0.95 | - | 达到95%巡航速度不超车 |
| 返回最小速度优势 | 8 | km/h | 返回原车道最小速度优势 |

### 6.2 距离参数

| 参数名 | 值 | 单位 | 说明 |
|--------|-----|------|------|
| 最大前车距离 | 80 | m | 前车距离超过此值不触发超车 |
| 侧方最小安全距离 | 30 | m | 侧方车辆最小安全距离 |
| 第二前车最小距离 | 150 | m | 第二前车最小距离 |
| 远距离超车最小距离 | 30 | m | 远距离超车最小距离 |
| 远距离超车最大距离 | 100 | m | 远距离超车最大距离 |
| 完全超越距离 | 50 | m | 目标侧车辆距离超过此值认为已超越 |

### 6.3 车道参数

| 参数名 | 值 | 单位 | 说明 |
|--------|-----|------|------|
| 最小车道线置信度 | 0.7 | - | 车道线检测最小置信度 |
| 最小车道宽度 | 3.0 | m | 变道所需最小车道宽度 |
| 允许变道车道线类型 | 0 | - | 0=虚线, 1=实线 |

### 6.4 道路条件参数

| 参数名 | 值 | 单位 | 说明 |
|--------|-----|------|------|
| 最大曲率 | 0.02 | rad/s | 超过此值认为在弯道 |
| 最大方向盘角度 | 15 | 度 | 超过此角度禁止超车 |
| 允许超车道路类型 | [1, 6] | - | 1=高速, 6=快速路 |

### 6.5 时间参数

| 参数名 | 值 | 单位 | 说明 |
|--------|-----|------|------|
| 防抖帧数 | 3 | 帧 | 连续3帧满足条件才触发 |
| 基础冷却时间 | 8 | 秒 | 基础冷却时间 |
| 成功冷却时间 | 15 | 秒 | 成功超车后冷却时间 |
| 失败冷却时间 | 3 | 秒 | 失败后快速重试时间 |
| 条件不满足冷却时间 | 5 | 秒 | 条件不满足冷却时间 |
| 车道记忆最大时间 | 30 | 秒 | 返回原车道最大等待时间 |
| 超越完成等待时间 | 2 | 秒 | 完全超越后等待时间 |

---

## 七、决策流程表

| 步骤 | 检查项 | 结果 | 下一步 |
|------|--------|------|--------|
| 1 | 超车模式检查 | 模式0 | 直接返回，不执行超车 |
| | | 模式1/2 | 继续 |
| 2 | 返回原车道检查（方案5） | 满足 | 发送返回命令，重置状态 |
| | | 不满足 | 继续 |
| 3 | 前置条件检查 | 不满足 | 记录状态，返回 |
| | | 满足 | 继续 |
| 4 | 超车需求判断 | 达到巡航速度（方案4） | 不超车，返回 |
| | | 远距离超车（方案3） | 继续超车流程 |
| | | 常规超车条件 | 继续超车流程 |
| | | 都不满足 | 不超车，返回 |
| 5 | 防抖机制 | 未达到3帧 | 继续累积 |
| | | 达到3帧 | 继续 |
| 6 | 超车可行性评估 | 左超车可行 | 选择左超车 |
| | | 右超车可行 | 选择右超车 |
| | | 都不可行 | 不超车，记录失败 |
| 7 | 动态冷却检查（方案1） | 冷却中 | 尝试另一方向（若可行） |
| | | 冷却完成 | 继续 |
| 8 | 发送变道命令 | 成功 | 记录成功状态，重置冷却 |
| | | 失败 | 记录失败状态，更新冷却 |

---

## 八、方案功能对比表

| 方案 | 功能 | 优先级 | 影响 | 实施难度 |
|------|------|--------|------|---------|
| **方案1** | 动态冷却机制 | ⭐⭐⭐⭐⭐ | 高 | 低 |
| **方案2** | 前车最低速度限制 | ⭐⭐⭐⭐⭐ | 高 | 低 |
| **方案3** | 远距离超车支持 | ⭐⭐⭐⭐ | 高 | 中 |
| **方案4** | 达到巡航速度检查 | ⭐⭐⭐⭐ | 中 | 低 |
| **方案5** | 返回原车道策略 | ⭐⭐⭐⭐ | 高 | 高 |

**说明**：
- 方案1和方案2为**必须实施**（第一阶段）
- 方案3和方案4为**优先实施**（第二阶段）
- 方案5为**评估后实施**（第三阶段）

---

## 九、超车模式说明表

| 模式 | 值 | 功能 | 说明 |
|------|-----|------|------|
| **禁止超车** | 0 | 不执行任何超车操作 | 系统完全禁用超车功能 |
| **拨杆超车** | 1 | 仅播放确认音 | 满足条件时播放提示音，建议用户手动拨杆触发 |
| **自动超车** | 2 | 自动检测并执行超车 | 系统自动判断并发送变道命令，同时播放方向提示音 |

**说明**：模式通过 `SharedPreferences` 的 `overtake_mode` 键控制。

---

## 十、自动超车与建议超车情况分析表

### 10.1 自动超车情况（模式2）

以下情况在**自动超车模式（模式2）**下，系统会**自动发送变道命令**并播放方向提示音：

| 序号 | 情况类型 | 触发条件 | 行为 | 说明 |
|------|---------|---------|------|------|
| 1 | **返回原车道** | 满足返回原车道条件（方案5） | 发送返回命令 + 播放方向音 | 智能返回原车道，符合交通规则 |
| 2 | **远距离超车**（方案3） | 高速/快速路 + 前车≥50km/h + 前车≤60%本车速度 + 速度差≥20km/h + 距离30-100m | 发送超车命令 + 播放方向音 | 提前超车，提高通行效率 |
| 3 | **常规超车（左超车）** | 满足前置条件 + 超车需求 + 左超车可行性全部满足 | 发送左超车命令 + 播放左方向音 | 优先左超车，符合中国交通规则 |
| 4 | **常规超车（右超车）** | 满足前置条件 + 超车需求 + 右超车可行性全部满足（左超车不可行时） | 发送右超车命令 + 播放右方向音 | 左超车不可行时的备用方案 |
| 5 | **备用方向超车** | 首选方向冷却中 + 备用方向可行 | 发送备用方向命令 + 播放方向音 | 提高超车成功率 |

**自动超车前置条件**（必须全部满足）：
- ✅ 系统已启用且激活
- ✅ 本车速度 ≥ 60 km/h
- ✅ 不在静止状态
- ✅ 道路类型为高速或快速路（roadcate in [1, 6]）
- ✅ 前车存在且距离 < 80m，置信度 ≥ 0.5
- ✅ 前车速度满足最低要求（高速≥35km/h，普通≥20km/h）
- ✅ 前车不在加速中（加速度 ≤ 0.2 m/s²）
- ✅ 未踩刹车
- ✅ 第二前车距离 ≥ 150m（或不存在）
- ✅ 不在弯道（曲率 < 0.02 rad/s）
- ✅ 系统未在变道中
- ✅ 方向盘角度 ≤ 15°

**自动超车需求条件**（满足任一即可）：
- ✅ **远距离超车**（方案3）：高速/快速路 + 前车≥50km/h + 前车≤60%本车速度 + 速度差≥20km/h + 距离30-100m
- ✅ **常规超车**：前车速度 < 限速×90% **且**（速度差≥10km/h **或** 前车速度≤80%本车速度）**且** 第二前车速度不超过本车+5m/s

**自动超车可行性条件**（左超车或右超车必须全部满足）：
- ✅ 车道线置信度 ≥ 0.7
- ✅ 车道线类型为虚线（0）
- ✅ 不在同向弯道（左超车不在左弯，右超车不在右弯）
- ✅ 车道宽度 ≥ 3.0m
- ✅ 盲区无车辆
- ✅ 侧方车辆距离 ≥ 30m
- ✅ 侧方车辆相对速度安全（动态阈值：`-max(5m/s, vEgo×0.3)`）

---

### 10.2 建议超车情况（模式1）

以下情况在**拨杆超车模式（模式1）**下，系统会**播放确认提示音**，建议用户手动拨杆触发：

| 序号 | 情况类型 | 触发条件 | 行为 | 说明 |
|------|---------|---------|------|------|
| 1 | **远距离超车建议**（方案3） | 高速/快速路 + 前车≥50km/h + 前车≤60%本车速度 + 速度差≥20km/h + 距离30-100m | 播放确认音 | 建议提前超车 |
| 2 | **常规超车建议（左超车）** | 满足前置条件 + 超车需求 + 左超车可行性全部满足 | 播放左确认音 | 建议左超车 |
| 3 | **常规超车建议（右超车）** | 满足前置条件 + 超车需求 + 右超车可行性全部满足（左超车不可行时） | 播放右确认音 | 建议右超车 |
| 4 | **备用方向超车建议** | 首选方向冷却中 + 备用方向可行 | 播放备用方向确认音 | 建议备用方向超车 |

**建议超车前置条件**（与自动超车相同）：
- ✅ 系统已启用且激活
- ✅ 本车速度 ≥ 60 km/h
- ✅ 不在静止状态
- ✅ 道路类型为高速或快速路（roadcate in [1, 6]）
- ✅ 前车存在且距离 < 80m，置信度 ≥ 0.5
- ✅ 前车速度满足最低要求（高速≥35km/h，普通≥20km/h）
- ✅ 前车不在加速中（加速度 ≤ 0.2 m/s²）
- ✅ 未踩刹车
- ✅ 第二前车距离 ≥ 150m（或不存在）
- ✅ 不在弯道（曲率 < 0.02 rad/s）
- ✅ 系统未在变道中
- ✅ 方向盘角度 ≤ 15°

**建议超车需求条件**（与自动超车相同）：
- ✅ **远距离超车**（方案3）：高速/快速路 + 前车≥50km/h + 前车≤60%本车速度 + 速度差≥20km/h + 距离30-100m
- ✅ **常规超车**：前车速度 < 限速×90% **且**（速度差≥10km/h **或** 前车速度≤80%本车速度）**且** 第二前车速度不超过本车+5m/s

**建议超车可行性条件**（与自动超车相同）：
- ✅ 车道线置信度 ≥ 0.7
- ✅ 车道线类型为虚线（0）
- ✅ 不在同向弯道
- ✅ 车道宽度 ≥ 3.0m
- ✅ 盲区无车辆
- ✅ 侧方车辆距离 ≥ 30m
- ✅ 侧方车辆相对速度安全

**注意**：模式1（拨杆超车）**不支持返回原车道功能**，因为返回原车道需要自动执行，不适合手动触发。

---

### 10.3 禁止超车情况（所有模式）

以下情况**所有模式**下都**不会触发超车**：

| 序号 | 禁止原因 | 条件 | 说明 |
|------|---------|------|------|
| 1 | 模式设置为禁止 | `overtake_mode == 0` | 用户主动禁用超车功能 |
| 2 | 系统未启用 | `systemState.enabled == false` | 系统未启用 |
| 3 | 系统未激活 | `systemState.active == false` | 系统未激活 |
| 4 | 速度过低 | `vEgo < 60 km/h` | 低于最小超车速度 |
| 5 | 静止状态 | `standstill == true` | 车辆静止 |
| 6 | 道路类型不允许 | `roadcate !in [1, 6]` | 非高速/快速路 |
| 7 | 前车不存在 | `lead0 == null` | 无前车 |
| 8 | 前车距离过远 | `lead0.x >= 80m` | 前车距离超过80米 |
| 9 | 前车置信度低 | `lead0.prob < 0.5` | 前车检测不可靠 |
| 10 | 前车速度过低 | 高速<35km/h 或 普通<20km/h | 可能为堵车 |
| 11 | 前车加速中 | `lead0.a > 0.2 m/s²` | 前车正在加速 |
| 12 | 正在刹车 | `brakePressed == true` | 用户正在刹车 |
| 13 | 第二前车过近 | `lead1.x < 150m` | 超车空间不足 |
| 14 | 在弯道中 | `abs(curvature) >= 0.02 rad/s` | 弯道禁止超车 |
| 15 | 正在变道 | `laneChangeState != 0` | 系统正在变道中 |
| 16 | 方向盘角度过大 | `abs(steeringAngleDeg) > 15°` | 转向角度过大 |
| 17 | 达到巡航速度 | `vEgo / desiredSpeed >= 0.95` | 已达到95%巡航速度 |
| 18 | 前车接近限速 | `vLead >= speedLimit × 0.9` | 前车速度接近限速 |
| 19 | 超车道有快车 | `lead1Speed - vEgo > 5 m/s` | 超车道有快车接近 |
| 20 | 冷却时间未到 | `now - lastTime < cooldown` | 仍在冷却期内 |

---

### 10.4 超车模式行为对比表

| 情况 | 模式0（禁止） | 模式1（拨杆） | 模式2（自动） |
|------|--------------|--------------|--------------|
| **返回原车道** | ❌ 不执行 | ❌ 不执行 | ✅ 自动执行 |
| **远距离超车** | ❌ 不执行 | 🔔 播放确认音 | ✅ 自动执行 |
| **常规左超车** | ❌ 不执行 | 🔔 播放左确认音 | ✅ 自动执行 |
| **常规右超车** | ❌ 不执行 | 🔔 播放右确认音 | ✅ 自动执行 |
| **备用方向超车** | ❌ 不执行 | 🔔 播放确认音 | ✅ 自动执行 |
| **音效播放** | ❌ 无 | ✅ 确认音 | ✅ 方向音 |

**图例**：
- ❌ = 不执行
- 🔔 = 播放确认音（建议用户手动拨杆）
- ✅ = 自动执行（发送变道命令 + 播放方向音）

---

## 十一、日志标识说明表

| 日志标识 | 含义 | 示例 |
|---------|------|------|
| ✅ | 超车成功 | `✅ 发送超车命令: LEFT, 原因: 左超车条件满足` |
| 🚀 | 远距离超车 | `🚀 远距离超车触发: 前车60km/h vs 本车80km/h` |
| ⚠️ | 警告信息 | `⚠️ 前车速度30km/h低于35km/h，可能为堵车，禁止超车` |
| 🔄 | 返回原车道 | `🔄 返回原车道: RIGHT` |
| 🎯 | 车道记忆 | `🎯 开始原车道记忆: 车道1, 方向: LEFT` |
| ⏰ | 超时重置 | `⏰ 返回超时(30秒)，重置状态` |
| 🔔 | 拨杆模式 | `🔔 拨杆模式播放确认音: LEFT` |

---

---

**文档版本**：1.1.0  
**最后更新**：2024年  
**更新内容**：新增"自动超车与建议超车情况分析表"，详细说明不同模式下的超车行为


# 自动超车系统开发文档

## 一、系统概述

### 1.1 系统简介

自动超车系统（`AutoOvertakeManager`）是一个智能化的车辆超车决策和执行系统，基于实时车辆数据（来自 `XiaogeDataReceiver`）进行超车条件判断，并自动发送变道命令给 comma3 设备。

### 1.2 核心功能

- ✅ **智能超车决策**：基于多维度条件判断是否需要超车
- ✅ **动态冷却机制**：根据超车结果自适应调整冷却时间
- ✅ **前车最低速度限制**：避免堵车误判
- ✅ **远距离超车支持**：提前超车，提高通行效率
- ✅ **达到巡航速度检查**：避免不必要超车
- ✅ **返回原车道策略**：智能返回原车道，符合交通规则

### 1.3 超车模式

系统支持三种超车模式（通过 `SharedPreferences` 的 `overtake_mode` 键控制）：

- **模式 0（禁止超车）**：不执行任何超车操作，系统完全禁用超车功能
- **模式 1（拨杆超车）**：满足超车条件时播放确认提示音，建议用户手动拨杆触发，不自动发送变道命令
- **模式 2（自动超车）**：满足超车条件时自动检测并执行超车，发送变道命令，同时播放方向提示音

### 1.4 自动超车与建议超车情况

#### 1.4.1 自动超车情况（模式2）

在**自动超车模式（模式2）**下，以下情况系统会**自动发送变道命令**：

1. **返回原车道**：满足返回原车道条件时，自动返回原车道
2. **远距离超车**（方案3）：高速/快速路上，提前超车（30-100米）
3. **常规左超车**：满足所有前置条件、超车需求和左超车可行性时
4. **常规右超车**：左超车不可行时，满足右超车可行性时
5. **备用方向超车**：首选方向冷却中，备用方向可行时

#### 1.4.2 建议超车情况（模式1）

在**拨杆超车模式（模式1）**下，以下情况系统会**播放确认提示音**，建议用户手动拨杆：

1. **远距离超车建议**：高速/快速路上，提前超车条件满足时
2. **常规左超车建议**：满足所有条件，建议左超车时
3. **常规右超车建议**：左超车不可行，建议右超车时
4. **备用方向超车建议**：首选方向冷却中，备用方向可行时

**注意**：模式1不支持返回原车道功能，因为返回原车道需要自动执行。

#### 1.4.3 禁止超车情况（所有模式）

以下情况所有模式下都不会触发超车：
- 模式设置为禁止（模式0）
- 系统未启用或未激活
- 速度过低（< 60 km/h）
- 道路类型不允许（非高速/快速路）
- 前车不存在或距离过远
- 前车速度过低（可能为堵车）
- 前车加速中或正在刹车
- 在弯道中或正在变道
- 达到巡航速度或前车接近限速
- 冷却时间未到

详细说明请参考《超车机制和条件说明表.md》的"十、自动超车与建议超车情况分析表"。

---

## 二、系统架构

### 2.1 核心类

```
AutoOvertakeManager
├── update()                    // 主更新函数
├── checkPrerequisites()        // 前置条件检查
├── shouldOvertake()           // 超车需求判断
├── checkOvertakeConditions()  // 超车可行性评估
├── checkLeftOvertakeFeasibility()   // 左超车可行性
├── checkRightOvertakeFeasibility()  // 右超车可行性
├── calculateDynamicCooldown()  // 动态冷却计算
├── checkLeadVehicleMinSpeed() // 前车最低速度检查
├── checkEarlyOvertakeConditions()  // 远距离超车检查
├── checkCruiseSpeedRatio()    // 巡航速度检查
├── checkReturnConditions()     // 返回原车道检查
└── sendLaneChangeCommand()    // 发送变道命令
```

### 2.2 数据流

```
XiaogeDataReceiver
    ↓
XiaogeVehicleData
    ↓
AutoOvertakeManager.update()
    ↓
条件检查 → 决策 → 发送命令
    ↓
NetworkManager.sendControlCommand()
    ↓
comma3 设备
```

---

## 三、核心逻辑详解

### 3.1 前置条件检查（`checkPrerequisites`）

所有前置条件必须**全部满足**才能进入超车流程：

#### 3.1.1 系统状态检查
- ✅ 系统已启用（`systemState.enabled == true`）
- ✅ 系统已激活（`systemState.active == true`）

#### 3.1.2 速度检查
- ✅ 本车速度 ≥ 60 km/h（`vEgo >= 16.67 m/s`）
- ✅ 不在静止状态（`!standstill`）

#### 3.1.3 道路类型检查
- ✅ 只允许高速或快速路（`roadcate in [1, 6]`）
  - `1` = 高速公路
  - `6` = 快速路

#### 3.1.4 前车检查
- ✅ 前车存在（`lead0 != null`）
- ✅ 前车距离 ≤ 80 米（`lead0.x < 80.0f`）
- ✅ 前车置信度 ≥ 0.5（`lead0.prob >= 0.5f`）
- ✅ **前车最低速度限制**（方案2）：
  - 高速/快速路：≥ 35 km/h
  - 普通道路：≥ 20 km/h
- ✅ 前车不在加速中（`lead0.a <= 0.5f`）

#### 3.1.5 第二前车检查
- ✅ 第二前车距离 ≥ 150 米（`lead1.x >= 150.0f`）或不存在

#### 3.1.6 道路条件检查
- ✅ 不在弯道（`abs(curvature.maxOrientationRate) < 0.02 rad/s`）
- ✅ 系统未在变道中（`laneChangeState == 0`）
- ✅ 方向盘角度 ≤ 15 度（`abs(steeringAngleDeg) <= 15.0f`）

---

### 3.2 超车需求判断（`shouldOvertake`）

判断是否需要超车，按优先级顺序检查：

#### 3.2.1 达到巡航速度检查（方案4）
- ✅ 如果当前速度 ≥ 95% 巡航速度，**不触发超车**
- 避免不必要的超车，减少频繁变道

#### 3.2.2 远距离超车支持（方案3）
- ✅ **优先检查**：满足条件时直接返回 `true`
- **条件**（仅在高速/快速路启用）：
  1. 前车速度 ≥ 50 km/h（避免堵车）
  2. 前车速度 ≤ 60% 本车速度
  3. 速度差 ≥ 20 km/h
  4. 距离在 30-100 米范围内
- **优势**：提前超车，提高通行效率，减少紧急变道风险

#### 3.2.3 常规超车条件
- ✅ 前车速度低于限速的 90%
- ✅ 速度差 ≥ 10 km/h **或** 前车速度 ≤ 80% 本车速度
- ✅ 第二前车速度不超过本车速度 +5 m/s

---

### 3.3 超车可行性评估（`checkOvertakeConditions`）

评估左超车和右超车的可行性，**优先选择左超车**（符合中国交通规则）。

#### 3.3.1 左超车可行性（`checkLeftOvertakeFeasibility`）

**必须全部满足**：

1. **车道线检查**
   - ✅ 左车道线置信度 ≥ 0.7（`leftLaneProb >= 0.7f`）
   - ✅ 左车道线类型为虚线（`leftLaneLine == 0`）

2. **弯道方向检查**
   - ✅ 不在左弯（`curvature.maxOrientationRate >= 0`）

3. **车道宽度检查**
   - ✅ 左车道宽度 ≥ 3.0 米（`laneWidthLeft >= 3.0f`）

4. **盲区检查**
   - ✅ 左盲区无车辆（`!leftBlindspot`）

5. **侧方车辆检查**
   - ✅ 左侧无近距离车辆（`leadLeft.dRel >= 30.0f`）
   - ✅ 左侧无快速接近车辆（`leadLeft.vRel >= -5.0f`）

#### 3.3.2 右超车可行性（`checkRightOvertakeFeasibility`）

**必须全部满足**（与左超车类似）：

1. **车道线检查**
   - ✅ 右车道线置信度 ≥ 0.7（`rightLaneProb >= 0.7f`）
   - ✅ 右车道线类型为虚线（`rightLaneLine == 0`）

2. **弯道方向检查**
   - ✅ 不在右弯（`curvature.maxOrientationRate <= 0`）

3. **车道宽度检查**
   - ✅ 右车道宽度 ≥ 3.0 米（`laneWidthRight >= 3.0f`）

4. **盲区检查**
   - ✅ 右盲区无车辆（`!rightBlindspot`）

5. **侧方车辆检查**
   - ✅ 右侧无近距离车辆（`leadRight.dRel >= 30.0f`）
   - ✅ 右侧无快速接近车辆（`leadRight.vRel >= -5.0f`）

---

### 3.4 动态冷却机制（方案1）

根据超车结果自适应调整冷却时间，提高成功率并避免频繁超车。

#### 3.4.1 基础冷却时间

| 超车结果 | 冷却时间 | 说明 |
|---------|---------|------|
| **成功** | 15 秒 | 成功后充分冷却，避免频繁超车 |
| **失败** | 3 秒 | 失败后快速重试，提高成功率 |
| **条件不满足** | 5 秒 | 条件不满足时中等冷却 |
| **其他** | 8 秒 | 基础冷却时间 |

#### 3.4.2 连续失败惩罚

- 连续失败次数 > 3 次时，增加额外冷却时间
- 额外冷却时间 = `min(10秒, 连续失败次数 × 2秒)`

#### 3.4.3 道路类型调整

- **高速/快速路**：冷却时间 × 0.8（更快重试）
- **普通道路**：冷却时间 × 1.2（更保守）

#### 3.4.4 状态跟踪

```kotlin
enum class OvertakeResult {
    NONE,              // 无结果
    SUCCESS,           // 成功
    FAILED,            // 失败
    CONDITION_NOT_MET  // 条件不满足
}
```

---

### 3.5 前车最低速度限制（方案2）

避免堵车误判，提高超车决策准确性。

#### 3.5.1 速度阈值

| 道路类型 | 最低速度 | 说明 |
|---------|---------|------|
| **高速/快速路** | ≥ 35 km/h | 避免在高速上误判堵车 |
| **普通道路** | ≥ 20 km/h | 避免在普通道路上误判堵车 |

#### 3.5.2 检查逻辑

```kotlin
if (leadSpeedKph < minSpeed) {
    // 前车速度过低，可能为堵车，禁止超车
    return false
}
```

---

### 3.6 远距离超车支持（方案3）

提前超车（30-100米），提高通行效率，减少紧急变道风险。

#### 3.6.1 触发条件

**仅在高速/快速路启用**，必须**全部满足**：

1. **前车最低速度**：≥ 50 km/h（避免堵车）
2. **速度比例**：前车速度 ≤ 60% 本车速度
3. **速度差**：≥ 20 km/h
4. **距离范围**：30-100 米

#### 3.6.2 优势

- ✅ 提前超车，避免接近慢车后再超车
- ✅ 减少紧急变道风险
- ✅ 提高通行效率

---

### 3.7 达到巡航速度检查（方案4）

避免不必要的超车，减少频繁变道。

#### 3.7.1 检查逻辑

```kotlin
if (vEgoKph / desiredSpeed >= 0.95f) {
    // 达到95%巡航速度，无需超车
    return false
}
```

#### 3.7.2 优势

- ✅ 减少不必要的超车
- ✅ 避免频繁变道
- ✅ 提高系统稳定性

---

### 3.8 返回原车道策略（方案5）

智能返回原车道，符合交通规则，避免长时间占用超车道。

#### 3.8.1 车道记忆

- **原车道记录**：超车开始时记录原车道号
- **净变道数**：`netLaneChanges`
  - `> 0`：在左侧（需要向右返回）
  - `< 0`：在右侧（需要向左返回）
- **超时机制**：30秒后自动重置车道记忆

#### 3.8.2 返回条件

**必须全部满足**：

1. **完全超越检查**（`hasCompletelyOvertaken`）
   - ✅ 目标侧无车或距离 > 50 米
   - ✅ 等待 2 秒确保完全超越

2. **返回效率检查**（`isReturnEfficient`）
   - ✅ 返回方向速度优势 ≥ 8 km/h
   - ✅ 计算目标车道和当前车道的预期速度差

3. **返回安全检查**（`isReturnSafe`）
   - ✅ 返回方向盲区无车辆
   - ✅ 返回方向无近距离车辆
   - ✅ 返回方向无快速接近车辆（相对速度 > 5 km/h 时，距离需安全）

#### 3.8.3 返回流程

```
超车开始 → 记录原车道 → 更新净变道数
    ↓
完全超越 → 等待2秒
    ↓
检查返回效率 → 检查返回安全
    ↓
发送返回命令 → 重置车道记忆
```

---

## 四、关键参数配置

### 4.1 速度阈值

| 参数 | 值 | 说明 |
|------|-----|------|
| `MIN_OVERTAKE_SPEED_MS` | 16.67 m/s (60 km/h) | 最小超车速度 |
| `SPEED_DIFF_THRESHOLD` | 2.78 m/s (10 km/h) | 速度差阈值 |
| `SPEED_RATIO_THRESHOLD` | 0.8 | 前车速度/本车速度阈值 |
| `HIGHWAY_LEAD_MIN_SPEED_KPH` | 35 km/h | 高速/快速路前车最低速度 |
| `NORMAL_LEAD_MIN_SPEED_KPH` | 20 km/h | 普通道路前车最低速度 |
| `EARLY_OVERTAKE_MIN_LEAD_SPEED_KPH` | 50 km/h | 远距离超车前车最低速度 |
| `EARLY_OVERTAKE_MIN_SPEED_DIFF_KPH` | 20 km/h | 远距离超车最小速度差 |
| `CRUISE_SPEED_RATIO_THRESHOLD` | 0.95 | 巡航速度比例阈值（95%） |
| `RETURN_MIN_SPEED_ADVANTAGE_KPH` | 8 km/h | 返回原车道最小速度优势 |

### 4.2 距离阈值

| 参数 | 值 | 说明 |
|------|-----|------|
| `MAX_LEAD_DISTANCE` | 80 m | 最大前车距离 |
| `MIN_SAFE_DISTANCE` | 30 m | 侧方最小安全距离 |
| `MIN_LEAD1_DISTANCE` | 150 m | 第二前车最小距离 |
| `EARLY_OVERTAKE_MIN_DISTANCE` | 30 m | 远距离超车最小距离 |
| `EARLY_OVERTAKE_MAX_DISTANCE` | 100 m | 远距离超车最大距离 |

### 4.3 车道线阈值

| 参数 | 值 | 说明 |
|------|-----|------|
| `MIN_LANE_PROB` | 0.7 | 最小车道线置信度 |
| `MIN_LANE_WIDTH` | 3.0 m | 最小车道宽度 |
| `ALLOWED_LANE_LINE_TYPE` | 0 | 允许变道的车道线类型（0=虚线） |

### 4.4 道路条件阈值

| 参数 | 值 | 说明 |
|------|-----|------|
| `MAX_CURVATURE` | 0.02 rad/s | 最大曲率（更严格的直道判断） |
| `MAX_STEERING_ANGLE` | 15° | 最大方向盘角度 |
| `ALLOWED_ROAD_TYPES` | [1, 6] | 允许超车的道路类型（1=高速, 6=快速路） |

### 4.5 时间参数

| 参数 | 值 | 说明 |
|------|-----|------|
| `DEBOUNCE_FRAMES` | 3 | 防抖帧数 |
| `COOLDOWN_BASE_MS` | 8000 ms | 基础冷却时间 |
| `COOLDOWN_SUCCESS_MS` | 15000 ms | 成功超车后冷却时间 |
| `COOLDOWN_FAILED_MS` | 3000 ms | 超车失败后冷却时间（快速重试） |
| `COOLDOWN_CONDITION_MS` | 5000 ms | 条件不满足冷却时间 |
| `MAX_LANE_MEMORY_TIME_MS` | 30000 ms | 车道记忆最大时间（30秒） |
| `OVERTAKE_COMPLETE_DURATION_MS` | 2000 ms | 超越完成等待时间（2秒） |

---

## 五、决策流程

### 5.1 主流程

```
update(data)
    ↓
检查超车模式（模式0直接返回）
    ↓
检查返回原车道条件（方案5）
    ↓
检查前置条件（checkPrerequisites）
    ↓
检查超车需求（shouldOvertake）
    ├─ 达到巡航速度检查（方案4）
    ├─ 远距离超车支持（方案3）
    └─ 常规超车条件
    ↓
防抖机制（3帧）
    ↓
评估超车方向（checkOvertakeConditions）
    ├─ 左超车可行性
    └─ 右超车可行性（优先左超车）
    ↓
动态冷却检查（方案1）
    ↓
发送变道命令（sendLaneChangeCommand）
    ↓
记录超车状态（方案1）
```

### 5.2 决策优先级

1. **返回原车道**（方案5）
2. **前置条件检查**
3. **达到巡航速度检查**（方案4）
4. **远距离超车支持**（方案3）
5. **常规超车条件**
6. **左超车可行性**（优先）
7. **右超车可行性**（备用）

---

## 六、数据模型

### 6.1 输入数据（`XiaogeVehicleData`）

```kotlin
data class XiaogeVehicleData(
    val carState: CarStateData?,        // 车辆状态
    val modelV2: ModelV2Data?,          // 模型数据
    val radarState: RadarStateData?,    // 雷达数据
    val systemState: SystemStateData?,  // 系统状态
    val carrotMan: CarrotManFields?    // CarrotMan字段
)
```

#### 6.1.1 车辆状态（`CarStateData`）

- `vEgo`: 本车速度（m/s）
- `standstill`: 是否静止
- `steeringAngleDeg`: 方向盘角度（度）
- `leftBlindspot`: 左盲区是否有车辆
- `rightBlindspot`: 右盲区是否有车辆
- `leftLaneLine`: 左车道线类型（0=虚线, 1=实线）
- `rightLaneLine`: 右车道线类型（0=虚线, 1=实线）

#### 6.1.2 模型数据（`ModelV2Data`）

- `lead0`: 第一前车
  - `x`: 距离（米）
  - `v`: 速度（m/s）
  - `a`: 加速度（m/s²）
  - `prob`: 置信度（0-1）
- `lead1`: 第二前车（同上）
- `laneLineProbs`: 车道线置信度数组 `[左, 右]`
- `curvature`: 曲率数据
  - `maxOrientationRate`: 最大转向率（rad/s）
  - `direction`: 方向（>0=右转, <0=左转）
- `meta`: 元数据
  - `laneWidthLeft`: 左车道宽度（米）
  - `laneWidthRight`: 右车道宽度（米）
  - `laneChangeState`: 变道状态（0=未变道）
  - `laneChangeDirection`: 变道方向

#### 6.1.3 雷达数据（`RadarStateData`）

- `leadOne`: 前车雷达数据
  - `dRel`: 相对距离（米）
  - `vRel`: 相对速度（m/s）
  - `vLead`: 前车速度（m/s）
- `leadLeft`: 左侧车辆数据（同上）
- `leadRight`: 右侧车辆数据（同上）

#### 6.1.4 CarrotMan字段（`CarrotManFields`）

- `roadcate`: 道路类型（1=高速, 6=快速路）
- `desiredSpeed`: 期望速度（km/h）
- `nRoadLimitSpeed`: 道路限速（km/h）

---

### 6.2 输出数据

#### 6.2.1 变道命令

通过 `NetworkManager.sendControlCommand()` 发送：

```kotlin
networkManager.sendControlCommand("LANECHANGE", direction)
// direction: "LEFT" 或 "RIGHT"
```

---

## 七、日志和调试

### 7.1 日志标签

所有日志使用标签：`AutoOvertakeManager`

### 7.2 关键日志

#### 7.2.1 超车成功
```
✅ 发送超车命令: LEFT, 原因: 左超车条件满足
```

#### 7.2.2 远距离超车
```
🚀 远距离超车触发: 前车60km/h vs 本车80km/h (慢20km/h, 距离50m)
```

#### 7.2.3 前车最低速度限制
```
⚠️ 前车速度30km/h低于35km/h，可能为堵车，禁止超车
```

#### 7.2.4 达到巡航速度
```
⚠️ 当前速度95km/h已达到巡航速度100km/h的95%，无需超车
```

#### 7.2.5 返回原车道
```
🔄 返回原车道: RIGHT
🎯 开始原车道记忆: 车道1, 方向: LEFT
⏰ 返回超时(30秒)，重置状态
```

---

## 八、最佳实践

### 8.1 参数调优

1. **根据实际测试调整阈值**
   - 速度阈值：根据道路类型和交通状况调整
   - 距离阈值：根据车辆性能和传感器精度调整
   - 冷却时间：根据超车成功率调整

2. **道路类型适配**
   - 高速/快速路：更激进的超车策略
   - 普通道路：更保守的超车策略

### 8.2 安全考虑

1. **多重安全检查**
   - 前置条件检查
   - 盲区检查
   - 侧方车辆检查
   - 弯道方向检查

2. **防抖机制**
   - 3帧连续满足条件才触发超车
   - 避免瞬时条件变化导致的误判

3. **冷却机制**
   - 成功后充分冷却，避免频繁超车
   - 失败后快速重试，提高成功率

### 8.3 性能优化

1. **数据检查顺序**
   - 先检查简单条件（系统状态、速度）
   - 再检查复杂条件（车道线、侧方车辆）

2. **缓存计算结果**
   - 避免重复计算速度、距离等

---

## 九、故障排查

### 9.1 常见问题

#### 问题1：系统不触发超车

**可能原因**：
- 超车模式设置为 0（禁止超车）
- 前置条件不满足（速度、道路类型等）
- 冷却时间未到

**排查步骤**：
1. 检查 `overtake_mode` 设置
2. 查看日志，确认前置条件检查结果
3. 检查冷却时间是否已过

#### 问题2：频繁超车

**可能原因**：
- 冷却时间设置过短
- 超车成功状态未正确记录

**排查步骤**：
1. 检查 `lastOvertakeResult` 状态
2. 检查冷却时间计算逻辑
3. 查看日志，确认超车成功状态记录

#### 问题3：返回原车道不工作

**可能原因**：
- 车道记忆未正确记录
- 返回条件不满足
- 超时重置

**排查步骤**：
1. 检查 `originalLaneNumber` 和 `netLaneChanges`
2. 查看返回条件检查日志
3. 检查是否超过 30 秒超时

---

## 十、未来改进方向

### 10.1 功能增强

1. **多车道超车支持**
   - 支持连续变道超车
   - 智能选择最优超车路径

2. **预测性超车**
   - 基于前方路况预测，提前规划超车
   - 考虑前方车辆行为预测

3. **协同超车**
   - 与其他车辆协同超车
   - 避免多车同时超车冲突

### 10.2 性能优化

1. **机器学习优化**
   - 基于历史数据优化参数
   - 自适应调整阈值

2. **传感器融合**
   - 融合多传感器数据
   - 提高检测精度和可靠性

---

## 十一、参考资料

### 11.1 相关文档

- `AutoOvertakeManager核心改进方案.md`：核心改进方案详细说明
- `自动超车系统对比分析.md`：Python 和 Kotlin 实现对比
- `映射关系.md`：数据映射关系说明

### 11.2 相关代码

- `AutoOvertakeManager.kt`：自动超车管理器主类
- `XiaogeDataReceiver.kt`：数据接收器
- `NetworkManager.kt`：网络管理器
- `CarrotManDataModels.kt`：数据模型定义

---

## 十二、版本历史

### v1.0.0（当前版本）

- ✅ 实现动态冷却机制（方案1）
- ✅ 实现前车最低速度限制（方案2）
- ✅ 实现远距离超车支持（方案3）
- ✅ 实现达到巡航速度检查（方案4）
- ✅ 实现返回原车道策略（方案5）
- ✅ 完整的日志和调试支持

---

**文档版本**：1.1.0  
**最后更新**：2024年  
**维护者**：开发团队  
**更新内容**：新增"自动超车与建议超车情况"章节，详细说明不同模式下的超车行为


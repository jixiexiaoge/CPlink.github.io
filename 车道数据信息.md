# 车道数据信息（KEY_TYPE=13012）

**概述**
- 广播 `Action: AUTONAVI_STANDARD_BROADCAST_SEND`，`KEY_TYPE=13012` 表示“车道线信息”。
- 载荷字段 `EXTRA_DRIVE_WAY` 为一个 JSON 字符串，包含前方路口的车道数量及每条车道允许的行驶方向。
- App 当前行为：解析 JSON、校验有效性、更新 `nLaneCount`，并原样输出 JSON 以便排查。

**字段说明**
- `drive_way_enabled`: 是否启用车道线数据。`true/false`；为 `false` 时不显示车道信息。
- `drive_way_size`: 车道数量（整数）。
- `drive_way_info`: 数组，每个元素是一条车道的信息：
  - `drive_way_number`: 车道序号（从左到右，0/1/2…）。
  - `drive_way_lane_Back_icon`: 车道箭头图标编号（字符串，表示允许的行驶方向，编号为高德内部代码）。
  - `trafficLaneAdvised`: 是否为当前路线推荐车道（布尔）。
  - `trafficLaneExtendedNew` / `drive_way_lane_Extended`: 扩展标志位（整型/字符串）。
  - `trafficLaneType`: 车道类型（整型，0为普通车道）。

**示例载荷（结构示意）**
```json
{
  "drive_way_enabled": "true",
  "drive_way_size": 2,
  "drive_way_info": [
    { "drive_way_number": "0", "drive_way_lane_Back_icon": "11", "trafficLaneAdvised": false, "trafficLaneExtendedNew": 0, "trafficLaneType": 0 },
    { "drive_way_number": "1", "drive_way_lane_Back_icon": "1",  "trafficLaneAdvised": false, "trafficLaneExtendedNew": 0, "trafficLaneType": 0 }
  ]
}
```
- 图标编号仅示例；实际编号以广播为准。

## 3. 图标编号映射逻辑 (Complex Lane Logic)

本项目采用了与高德官方 `DriveWayLinear.java` 一致的复杂车道映射逻辑。图标的选择不仅取决于车道 ID，还取决于当前的导航动作（Action）。

### 3.1 映射原理
App 结合以下两个信息来决定最终显示的车道图标：
1.  **车道类型 ID (Lane ID)**: 来自 `KEY_TYPE=13012` 的 `drive_way_lane_Back_icon` 字段。
2.  **导航动作 (Navi Action)**: 来自 `KEY_TYPE=10001` 的 `ICON` 字段（映射为 `ACTION_LEFT`, `ACTION_AHEAD` 等）。

### 3.2 核心映射表 (Lane ID + Action -> Resource)
资源查找时优先尝试 `global_image_` 前缀（如 `global_image_landfront_a0.png`）。

| 车道 ID (Dec) | 含义 | 导航动作 (Action) | 结果资源名 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **10** (0xA) | 直行 + 右掉头 | 直行 (Ahead) <br> 右掉头 (RU_Turn) | `landfront_a0` <br> `landfront_a8` | |
| **9** | 直行 + 左掉头 | 直行 (Ahead) <br> 左掉头 (LU_Turn) | `landfront_90` <br> `landfront_95` | |
| **2** | 直行 + 左转 | 直行 (Ahead) <br> 左转 (Left) | `landfront_20` <br> `landfront_21` | |
| **4** | 直行 + 右转 | 直行 (Ahead) <br> 右转 (Right) | `landfront_40` <br> `landfront_43` | |
| **6** | 左转 + 右转 | 左转 (Left) <br> 右转 (Right) | `landfront_61` <br> `landfront_63` | |
| **7** | 直行 + 左转 + 右转 | 直行 (Ahead) <br> 左转 (Left) <br> 右转 (Right) | `landfront_70` <br> `landfront_71` <br> `landfront_73` | |
| **11** (0xB) | 左转 + 左掉头 | 左掉头 (LU_Turn) <br> 左转 (Left) | `landfront_b5` <br> `landfront_b1` | |
| **12** (0xC) | 右转 + 右掉头 | 右掉头 (RU_Turn) <br> 右转 (Right) | `landfront_c8` <br> `landfront_c3` | |
| **13** (0xD) | 直行 + 右转 + 右掉头 | 直行 / 右转 / 右掉头 | `landfront_70` / `73` / `c8` | 复用 ID 7 和 12 的资源 |
| **14** (0xE) | 左转 + 左掉头(扩展) | 左转 (Left) <br> 左掉头 (LU_Turn) | `landfront_e1` <br> `landfront_e5` | |
| **19** (0x13) | 左转 + 右掉头 | 左转 (Left) <br> 右掉头 (RU_Turn) | `landfront_j1` <br> `landfront_j8` | |
| **20** (0x14) | 公交车道 | (任意) | `landfront_kk` | |
| **21** (0x15) | 可变车道 | (任意) | `landback_l` | |

### 3.3 特殊 ID 纠正表
针对一些非标准或需要覆盖的 ID，App 进行了强制映射：

| 原始 ID | 结果资源名 | 含义 |
| :--- | :--- | :--- |
| **18** | `auto_landback_3` | 右转 |
| **15** | `auto_landback_0` | 直行 |
| **32** | `landfront_40` | 直行 + 右转 |
| **30** | `landfront_20` | 直行 + 左转 |
| **16** | `auto_landback_1` | 左转 |
| **1** | `landback_1` | 左转 |
| **0** | `landback_0` | 直行 |
| **3** | `landback_3` | 右转 |
| **4** | `landback_4` | 直行 + 右转 |
| **54** | `landfront_15` | 左转 (特殊) |
| **5** | `landback_5` | 左掉头 |

### 3.4 Auto 系列映射 (ID >= 15)
当 ID 大于等于 15 时，App 会尝试进行偏移映射（ID - 15）：

| 原始 ID | 偏移 ID | 资源名 (auto_landback_*) | 备注 |
| :--- | :--- | :--- | :--- |
| 15 | 0 | `auto_landback_0` | 直行 |
| 16 | 1 | `auto_landback_1` | 左转 |
| 17 | 2 | `auto_landback_2` | 直行 + 左转 |
| 18 | 3 | `auto_landback_3` | 右转 |
| ... | ... | ... | |

### 3.5 基础回退图标 (landback_)
若以上映射均未匹配，则使用基础图标作为回退：

| 车道 ID | 资源名 | 含义 |
| :--- | :--- | :--- |
| 0 | `landback_0` | 直行 |
| 1 | `landback_1` | 左转 |
| 3 | `landback_3` | 右转 |
| 5 | `landback_5` | 左掉头 |
| 8 | `landback_8` | 右掉头 |

### 3.6 导航动作映射 (Navi Icon -> Action)
在 `LaneIconHelper.mapNaviIconToAction` 中定义：

| Action ID | 含义 | 对应高德 Navi Icon (TBT) |
| :--- | :--- | :--- |
| 0 | ACTION_AHEAD | 9 |
| 1 | ACTION_LEFT | 2, 4 |
| 3 | ACTION_RIGHT | 3, 5 |
| 5 | ACTION_LU_TURN | 6 |
| 8 | ACTION_RU_TURN | 7 |

## 4. UI 显示配置

为了更贴近高德地图的原生视觉体验，车道信息组件采用了以下配置：

- **背景颜色**: `0xFF0091FF` (高德地图品牌蓝)。
- **推荐车道**: 使用绿色外框 (`0xFF10B981`) 框住图标，并带有浅绿色背景。
- **调试信息**: (当前已在 UI 中注释) 图标下方曾以一行小字 (`7.sp`) 显示 `driveWayNumber|driveWayLaneExtended|trafficLaneExtendedNew|trafficLaneType`。
- **最小高度**: `52.dp`，确保图标在不同屏幕尺寸下都有足够的显示空间。

### 5. MainActivityUI.kt 调用的图标列表汇总

#### 5.1 复杂映射 (landfront_)
`a0`, `a8`, `90`, `95`, `20`, `21`, `40`, `43`, `61`, `63`, `70`, `71`, `73`, `b1`, `b5`, `c3`, `c8`, `e1`, `e5`, `j1`, `j8`, `kk`, `15`

#### 5.2 基础图标 (landback_)
`0`, `1`, `3`, `4`, `5`, `8`, `l`

#### 5.3 Auto 系列 (auto_landback_)
`0` 到 `e` (对应 ID 0-14 或 15-29)



# 高德 CAMERA_TYPE → Python nSdiType 映射关系表

## 映射关系总览

| 高德 CAMERA_TYPE | 高德描述 | Python nSdiType | Python描述(中文) | 映射方式 |
|-----------------|---------|----------------|-----------------|---------|
| 0 | 超速拍照 | 1 | 固定测速摄像头 | 🔄 映射 |
| 1 | 道路拍照 | 14 | 治安监控 | 🔄 映射 |
| 2 | 闯红灯拍照 | 6 | 闯红灯拍照 | 🔄 映射 |
| 3 | 违章拍照 | 17 | 违停拍照点 | 🔄 映射 |
| 4 | 公交专用道摄像头 | 9 | 公交专用车道区间 | 🔄 映射 |
| 5 | 应急车道拍照 | 11 | 应急车道拍照 | 🔄 映射 |
| 6 | 测速拍照 | 8 | 测速拍照 | 🔄 映射 |
| 7 | 非机动车道拍照 | 7 | 流动测速摄像头 | ✅ 直接引用 ⚠️ 描述不匹配 |
| 8 | 区间限速启点 | 2 | 区间测速开始 | 🔄 映射 |
| 9 | 区间限速终点 | 3 | 区间测速结束 | 🔄 映射 |
| 10 | 流动测速电子眼 | 7 | 流动测速摄像头 | 🔄 映射 |
| 11 | ECT计费拍照 | 26 | ETC计费拍照 | 🔄 映射 |
| 12 | 人行道拍照 | 41 | 行人乱穿马路多发处 | 🔄 映射 |
| 13 | 礼让行人拍照 | 41 | 行人乱穿马路多发处 | 🔄 映射 |
| 14 | ⚠️ 待确认 | 14 | 治安监控 | ✅ 直接引用 |
| 15 | 超载车辆风险区 | 15 | 超载车辆风险区 | ✅ 直接引用 |
| 16 | 装载不当拍照 | 16 | 装载不当拍照 | ✅ 直接引用 |
| 17 | 违停拍照点 | 17 | 违停拍照点 | ✅ 直接引用 |
| 18 | 未系安全带拍照 | 18 | 单行道 | ✅ 直接引用 ⚠️ 描述不匹配 |
| 19 | 接打手机拍照 | 19 | 铁路道口 | ✅ 直接引用 ⚠️ 描述不匹配 |
| 20 | 学校区域开始 | 20 | 学校区域开始 | ✅ 直接引用 |
| 21 | 学校区域结束 | 21 | 学校区域结束 | ✅ 直接引用 |
| 22 | ⚠️ 待确认 | 22 | 减速带 | ✅ 直接引用 |
| 23 | LPG加气站 | 23 | LPG加气站 | ✅ 直接引用 |
| 24 | 隧道区间 | 24 | 隧道区间 | ✅ 直接引用 |
| 25 | 服务区 | 25 | 服务区 | ✅ 直接引用 |
| 26 | 收费站 | 26 | ETC计费拍照 | ✅ 直接引用 |
| 27 | 多雾路段 | 27 | 多雾路段 | ✅ 直接引用 |
| 28 | 危险品区域 | 28 | 危险品区域 | ✅ 直接引用 |
| 29 | 事故多发路段 | 29 | 事故多发路段 | ✅ 直接引用 |
| 30 | ⚠️ 待确认 | 30 | 急弯路段 | ✅ 直接引用 |
| 31 | 急弯区段1 | 31 | 急弯区段1 | ✅ 直接引用 |
| 32 | 陡坡路段 | 32 | 陡坡路段 | ✅ 直接引用 |
| 33 | 野生动物出没路段 | 33 | 野生动物出没路段 | ✅ 直接引用 |
| 34 | 右侧视野不良点 | 34 | 右侧视野不良点 | ✅ 直接引用 |
| 35 | 视野不良点 | 35 | 视野不良点 | ✅ 直接引用 |
| 36 | 左侧视野不良点 | 36 | 左侧视野不良点 | ✅ 直接引用 |
| 37 | 闯红灯多发 | 37 | 闯红灯多发 | ✅ 直接引用 |
| 38 | 超速多发 | 38 | 超速多发 | ✅ 直接引用 |
| 39 | 交通拥堵区域 | 39 | 交通拥堵区域 | ✅ 直接引用 |
| 40 | 按方向选择车道点 | 40 | 按方向选择车道点 | ✅ 直接引用 |
| 41 | 行人乱穿马路多发处 | 41 | 行人乱穿马路多发处 | ✅ 直接引用 |
| 42 | 应急车道事故多发 | 42 | 应急车道事故多发 | ✅ 直接引用 |
| 43 | 超速事故多发 | 43 | 超速事故多发 | ✅ 直接引用 |
| 44 | 疲劳驾驶事故多发 | 44 | 疲劳驾驶事故多发 | ✅ 直接引用 |
| 45 | 事故多发点 | 45 | 事故多发点 | ✅ 直接引用 |
| 46 | 行人事故多发点 | 46 | 行人事故多发点 | ✅ 直接引用 |
| 47 | 车辆盗窃多发点 | 47 | 车辆盗窃多发点 | ✅ 直接引用 |
| 48 | 落石危险路段 | 48 | 落石危险路段 | ✅ 直接引用 |
| 49 | 路面结冰危险 | 49 | 路面结冰危险 | ✅ 直接引用 |
| 50 | 瓶颈路段 | 50 | 瓶颈路段 | ✅ 直接引用 |
| 51 | 汇入道路 | 51 | 汇入道路 | ✅ 直接引用 |
| 52 | 坠落危险路段 | 52 | 坠落危险路段 | ✅ 直接引用 |
| 53 | 地下车道区间 | 53 | 地下车道区间 | ✅ 直接引用 |
| 54 | 居民区（交通缓和） | 54 | 居民区（交通缓和） | ✅ 直接引用 |
| 55 | 立交 | 55 | 立交 | ✅ 直接引用 |
| 56 | 分岔点 | 56 | 分岔点 | ✅ 直接引用 |
| 57 | 服务区（可加气） | 57 | 服务区（可加气） | ✅ 直接引用 |
| 58 | 桥梁 | 58 | 桥梁 | ✅ 直接引用 |
| 59 | 制动故障事故多发点 | 59 | 制动故障事故多发点 | ✅ 直接引用 |
| 60 | 越线事故多发点 | 60 | 越线事故多发点 | ✅ 直接引用 |
| 61 | 违法通行事故多发点 | 61 | 违法通行事故多发点 | ✅ 直接引用 |
| 62 | 目的地在对面 | 62 | 目的地在对面 | ✅ 直接引用 |
| 63 | 瞌睡停车区 | 63 | 瞌睡停车区 | ✅ 直接引用 |
| 64 | 老旧柴油车管制 | 64 | 老旧柴油车管制 | ✅ 直接引用 |
| 65 | 隧道内变道拍照 | 65 | 隧道内变道拍照 | ✅ 直接引用 |
| else | 其他未知 | 66 | 空/忽略 | 🔄 映射 |

---

## 映射方式说明

### ✅ 直接引用
CAMERA_TYPE 和 nSdiType 值相同，直接传递使用。共 **49** 个类型（7, 14-65，不包括10）。

**注意**：部分直接引用的类型虽然值相同，但高德描述与 Python 描述不完全匹配：
- CAMERA_TYPE=7: 非机动车道拍照 → nSdiType=7: 流动测速摄像头
- CAMERA_TYPE=18: 未系安全带拍照 → nSdiType=18: 单行道
- CAMERA_TYPE=19: 接打手机拍照 → nSdiType=19: 铁路道口

### 🔄 映射
CAMERA_TYPE 和 nSdiType 值不同，需要转换映射。共 **15** 个类型：
- 0 → 1 (超速拍照 → 固定测速摄像头)
- 1 → 14 (道路拍照 → 治安监控)
- 2 → 6 (闯红灯拍照 → 闯红灯拍照)
- 3 → 17 (违章拍照 → 违停拍照点)
- 4 → 9 (公交专用道摄像头 → 公交专用车道区间)
- 5 → 11 (应急车道拍照 → 应急车道拍照)
- 6 → 8 (测速拍照 → 测速拍照)
- 8 → 2 (区间限速启点 → 区间测速开始)
- 9 → 3 (区间限速终点 → 区间测速结束)
- 10 → 7 (流动测速电子眼 → 流动测速摄像头)
- 11 → 26 (ECT计费拍照 → ETC计费拍照)
- 12 → 41 (人行道拍照 → 行人乱穿马路多发处)
- 13 → 41 (礼让行人拍照 → 行人乱穿马路多发处)
- else → 66 (其他未知 → 空/忽略)

### ⚠️ 待确认
CAMERA_TYPE=14, 22, 30 的描述还在确认中。

---

## 缺失映射分析

### 1. 高德 CAMERA_TYPE 待确认描述

| CAMERA_TYPE | 状态 | 说明 |
|------------|------|------|
| **14** | ⚠️ **待确认** | 当前映射到 nSdiType=14 (治安监控)，但高德描述还在确认中 |
| **22** | ⚠️ **待确认** | 当前映射到 nSdiType=22 (减速带)，但高德描述还在确认中 |
| **30** | ⚠️ **待确认** | 当前映射到 nSdiType=30 (急弯路段)，但高德描述还在确认中 |

### 2. Python nSdiType 未被使用的类型

| nSdiType | Python描述(中文) | 状态 | 说明 |
|---------|----------------|------|------|
| **0** | 信号测速/闯灯拍照 | ⚠️ 未使用 | 可能对应 CAMERA_TYPE=2（闯红灯拍照），但当前映射到6 |
| **4** | 区间测速中 | ✅ 特殊处理 | 由 KEY_TYPE:12110 动态设置，不需要 CAMERA_TYPE 映射 |
| **5** | 路口压线摄像头 | ⚠️ 未使用 | 高德可能没有对应的 CAMERA_TYPE |
| **10** | 可变/潮汐车道拍照 | ⚠️ 未使用 | 高德可能没有对应的 CAMERA_TYPE |
| **12** | 禁止加塞 | ⚠️ 未使用 | 高德可能没有对应的 CAMERA_TYPE |
| **13** | 交通信息采集点 | ⚠️ 未使用 | 高德可能没有对应的 CAMERA_TYPE |

---

## 特殊说明

### 区间测速处理逻辑

1. **区间测速开始** (nSdiType=2)
   - 由 KEY_TYPE:10001 处理
   - CAMERA_TYPE=8 → nSdiType=2

2. **区间测速中** (nSdiType=4)
   - 由 KEY_TYPE:12110 处理
   - 当检测到区间测速字段时，动态设置 nSdiType=4
   - **不需要 CAMERA_TYPE 映射**

3. **区间测速结束** (nSdiType=3)
   - 由 KEY_TYPE:10001 处理
   - CAMERA_TYPE=9 → nSdiType=3

---

## 建议修复

### 1. 补充 CAMERA_TYPE=10 的映射 ✅ 已修复

CAMERA_TYPE=10 已确认为"流动测速电子眼"，映射到 nSdiType=7 (流动测速摄像头)。

### 2. 确认 CAMERA_TYPE=14, 22, 30 的描述

需要确认以下 CAMERA_TYPE 的实际描述：
- CAMERA_TYPE=14: 当前映射到 nSdiType=14 (治安监控)
- CAMERA_TYPE=22: 当前映射到 nSdiType=22 (减速带)
- CAMERA_TYPE=30: 当前映射到 nSdiType=30 (急弯路段)

### 3. 考虑 nSdiType=0 的使用

nSdiType=0 表示"信号测速/闯灯拍照"，可能与 CAMERA_TYPE=2（闯红灯拍照）相关。
当前 CAMERA_TYPE=2 映射到 nSdiType=6（闯红灯拍照），可能需要根据实际情况调整。

---

## 映射覆盖率统计

- **已映射的 CAMERA_TYPE**: 66/66 (100%) ✅
- **待确认描述的 CAMERA_TYPE**: 3 个 (14, 22, 30)
- **直接引用的类型**: 49 个 (74.2%)
- **需要映射的类型**: 15 个 (22.7%)
- **未使用的 nSdiType**: 5 个 (0, 5, 10, 12, 13)
  - 注：nSdiType=4 是特殊处理，不算缺失

---

## 代码实现位置

### Android 端
- **文件**: `app/src/main/java/com/example/carrotamap/AmapBroadcastHandlers.kt`
- **函数**: `mapAmapCameraTypeToSdi(cameraType: Int): Int` (第107-176行)
- **文件**: `app/src/main/java/com/example/carrotamap/AmapTrafficHandlers.kt`
- **函数**: `mapAmapCameraTypeToSdi(cameraType: Int): Int` (第24-93行)

### Python 端
- **文件**: `carrot_serv.py`
- **函数**: `_get_sdi_descr(self, nSdiType)` (第400-618行)
- **说明**: 定义了 nSdiType 0-66 的中文、英文、韩文描述

---

# 高德地图 ICON → CarrotMan nTBTTurnType 映射关系表

## 映射关系总览

| 高德 ICON | 高德描述 | nTBTTurnType | Python navType | Python navModifier | Python xTurnInfo | 映射方式 |
|----------|---------|-------------|---------------|-------------------|-----------------|---------|
| 0 | 无转弯/通知指令 | 51 | notification | straight | None | 🔄 映射 |
| 1 | 直行 | 51 | notification | straight | None | 🔄 映射 |
| 2 | 左转 | 12 | turn | left | 1 | 🔄 映射 |
| 3 | 右转 | 13 | turn | right | 2 | 🔄 映射 |
| 4 | 左前方 | 102 | off ramp | slight left | 3 | 🔄 映射 |
| 5 | 右前方 | 101 | off ramp | slight right | 4 | 🔄 映射 |
| 6 | 左后方 | 17 | fork | left | 3 | 🔄 映射 |
| 7 | 右后方 | 19 | turn | sharp right | 2 | 🔄 映射 |
| 8 | 掉头 | 14 | turn | uturn | 7 | 🔄 映射 |
| 9 | 直行 | 51 | notification | straight | None | 🔄 映射 |
| 10 | 到达途经点 | 202 | - | - | - | 🔄 映射（自定义） |
| 11 | 进入环岛（右侧通行） | 131 | rotary | slight right | 5 | 🔄 映射 |
| 12 | 驶出环岛（右侧通行） | 132 | rotary | slight right | 5 | 🔄 映射 |
| 13 | 到达服务区 | 55 | notification | straight | None | 🔄 映射 |
| 14 | 到达收费站 | 206 | - | - | - | 🔄 映射（自定义） |
| 15 | 到达目的地 | 201 | arrive | straight | 8 | 🔄 映射 |
| 16 | 到达/进入隧道 | 207 | - | - | - | 🔄 映射（自定义） |
| 17 | 左侧通行环岛：进入 | 140 | rotary | slight left | 5 | 🔄 映射 |
| 18 | 左侧通行环岛：驶出 | 141 | rotary | slight left | 5 | 🔄 映射 |
| 19 | 右转掉头 | 14 | turn | uturn | 7 | 🔄 映射 |
| 20 | 顺行 | 51 | notification | straight | None | 🔄 映射 |
| 21 | 标准小环岛左转 | 133 | rotary | right | 5 | 🔄 映射 |
| 22 | 标准小环岛右转 | 139 | rotary | left | 5 | 🔄 映射 |
| 23 | 标准小环岛直行 | 142 | rotary | straight | 5 | 🔄 映射 |
| 24 | 标准小环岛调头 | 134 | rotary | sharp right | 5 | 🔄 映射 |
| 25 | 左侧通行小环岛左转 | 133 | rotary | right | 5 | 🔄 映射 |
| 26 | 左侧通行小环岛右转 | 139 | rotary | left | 5 | 🔄 映射 |
| 27 | 左侧通行小环岛直行 | 142 | rotary | straight | 5 | 🔄 映射 |
| 28 | 左侧通行小环岛调头 | 134 | rotary | sharp right | 5 | 🔄 映射 |
| 55 | 行驶到出口 | 55 | notification | straight | None | ✅ 直接引用 |
| 65 | 高架靠左行驶 | 102 | off ramp | slight left | 3 | 🔄 映射 |
| 66 | 高架靠右下匝道 | 101 | off ramp | slight right | 4 | 🔄 映射 |
| 101 | 向右进入辅道 | 1007 | off ramp | right | 4 | 🔄 映射 |
| else | 其他未知 | amapIcon | invalid | "" | -1 | ✅ 直接引用 |

---

## ICON 映射方式说明

### ✅ 直接引用
高德 ICON 和 nTBTTurnType 值相同，直接传递使用：
- **55**: 行驶到出口 → nTBTTurnType=55
- **else**: 其他未知 → 保持原值

### 🔄 映射
高德 ICON 和 nTBTTurnType 值不同，需要转换映射。共 **30+** 个类型。

### 🔄 映射（自定义）
Android 端自定义的 nTBTTurnType，Python 端未定义：
- **202**: 到达途经点（Android 自定义）
- **206**: 到达收费站（Android 自定义）
- **207**: 到达/进入隧道（Android 自定义）

---

## Python 端 nTBTTurnType → navType/navModifier/xTurnInfo 映射

### xTurnInfo 说明
- **1**: left turn (左转)
- **2**: right turn (右转)
- **3**: left lane change (左变道)
- **4**: right lane change (右变道)
- **5**: rotary (环岛)
- **6**: tg (交通灯)
- **7**: arrive or uturn (到达或掉头)
- **8**: arrive (到达目的地)
- **0/None**: notification (通知，无转向)

### 主要映射类型

| nTBTTurnType | navType | navModifier | xTurnInfo | 说明 |
|-------------|---------|------------|----------|------|
| 12 | turn | left | 1 | 左转 |
| 13 | turn | right | 2 | 右转 |
| 14 | turn | uturn | 7 | 掉头 |
| 16 | turn | sharp left | 1 | 急左转 |
| 19 | turn | sharp right | 2 | 急右转 |
| 51-55 | notification | straight | 0/None | 通知/直行 |
| 101 | off ramp | slight right | 4 | 轻微右（匝道） |
| 102 | off ramp | slight left | 3 | 轻微左（匝道） |
| 131-142 | rotary | * | 5 | 环岛相关 |
| 201 | arrive | straight | 8 | 到达目的地 |
| 202 | - | - | - | 到达途经点（自定义） |
| 206 | - | - | - | 到达收费站（自定义） |
| 207 | - | - | - | 到达隧道（自定义） |

---

## 特殊说明

### 1. 环岛处理
- **右侧通行环岛**: ICON 11-12, 21-24 → nTBTTurnType 131-142
- **左侧通行环岛**: ICON 17-18, 25-28 → nTBTTurnType 131-142
- Python 端统一处理为 rotary 类型，xTurnInfo=5

### 2. 自定义类型
Android 端定义了 3 个自定义 nTBTTurnType：
- **202**: 到达途经点
- **206**: 到达收费站
- **207**: 到达/进入隧道

这些类型在 Python 端的 `turn_type_mapping` 中未定义，需要特殊处理。

### 3. 通知类型
多个高德 ICON 映射到 nTBTTurnType=51-55（通知类型）：
- ICON 0, 1, 9, 20 → 51 (通知/直行)
- ICON 13 → 55 (到达服务区)
- ICON 55 → 55 (行驶到出口)

---

## 代码实现位置

### Android 端
- **文件**: `app/src/main/java/com/example/carrotamap/AmapBroadcastHandlers.kt`
- **函数**: `mapAmapIconToCarrotTurn(amapIcon: Int): Int` (第644-693行)
- **说明**: 将高德地图 ICON 映射到 CarrotMan nTBTTurnType

### Python 端
- **文件**: `carrot_serv.py`
- **函数**: `_update_tbt(self)` (第333-399行)
- **变量**: `turn_type_mapping` (第335-383行)
- **变量**: `nav_type_mapping` (第23-77行，全局)
- **说明**: 将 nTBTTurnType 映射到 (navType, navModifier, xTurnInfo)

---

# 高德地图 ROAD_TYPE → CarrotMan roadcate 映射关系表

## 映射关系总览

| 高德 ROAD_TYPE | 高德描述 | CarrotMan roadcate | roadcate描述 | 映射方式 |
|---------------|---------|-------------------|-------------|---------|
| 0 | 高速公路 | 10 | 很宽道路（四车道及以上） | 🔄 映射 |
| 1 | 国道 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 2 | 省道 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 3 | 县道 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 4 | 乡公路 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 5 | 县乡村内部道路 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 6 | 快速道 | 10 | 很宽道路（四车道及以上） | 🔄 映射 |
| 7 | 主要道路 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 8 | 次要道路 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 9 | 普通道路 | 6 | 中等宽度（双车道） | 🔄 映射 |
| 10 | 非导航道路 | 6 | 中等宽度（双车道） | 🔄 映射 |
| else | 未知道路类型 | 6 | 中等宽度（双车道） | 🔄 映射 |

---

## 道路类型映射方式说明

### 🔄 映射规则

**roadcate 含义说明**：
- **roadcate is the width of the road, 10,11 is the highway**
- **10, 11**: 很宽道路（四车道及以上），表示高速公路
- **6**: 中等宽度（双车道），表示非高速公路
- **其他值**: 根据实际道路宽度定义

**映射逻辑**：
1. **高速公路类型** (roadcate=10):
   - ROAD_TYPE=0 (高速公路)
   - ROAD_TYPE=6 (快速道)

2. **非高速公路类型** (roadcate=6):
   - 其他所有 ROAD_TYPE (1, 2, 3, 4, 5, 7, 8, 9, 10, else)

### 特殊处理

**限速修正规则**：
- 当 ROAD_TYPE=0 (高速公路) 或 ROAD_TYPE=6 (快速道)，且 LIMITED_SPEED=40 时
- 强制修正为 55km/h（避免误报的堵车限速）

---

## 代码实现位置

### Android 端
- **文件**: `app/src/main/java/com/example/carrotamap/AmapBroadcastHandlers.kt`
- **函数**: `mapRoadTypeToRoadcate(roadType: Int): Int` (第1225-1235行)
- **函数**: `getRoadTypeDescription(roadType: Int): String` (第1241-1256行)
- **函数**: `getRoadcateDescription(roadcate: Int): String` (第1263-1272行)
- **说明**: 将高德地图 ROAD_TYPE 映射到 CarrotMan roadcate

### Python 端
- **文件**: `carrot_serv.py`
- **变量**: `self.roadcate` (第132行，默认值8)
- **说明**: Python 端接收 roadcate 值，用于判断道路类型（10,11=高速公路）

---

# 高德地图交通红绿灯状态 → CarrotMan traffic_state 映射关系表

## 映射关系总览

| 高德 trafficLightStatus | 高德描述 | CarrotMan traffic_state | CarrotMan描述 | 方向条件 | 映射方式 |
|------------------------|---------|----------------------|-------------|---------|---------|
| -1 | 无效/未知 | -1 | 无效 | - | ✅ 直接引用 |
| 0 | 关闭/无信号 | 0 | off (关闭) | - | ✅ 直接引用 |
| 1 | 红灯 | 1 | red (红灯) | - | ✅ 直接引用 |
| 2 | 绿灯 | 2 或 3 | green (绿灯) 或 left (左转绿灯) | direction=1或3 → 3<br>其他 → 2 | 🔄 条件映射 |
| 3 | 黄灯 | 1 | red (红灯) | - | 🔄 映射 |
| 4 | 绿灯 | 2 | green (绿灯) | - | 🔄 映射 |
| else | 其他未知 | 0 | off (关闭) | - | 🔄 映射 |

---

## 交通红绿灯映射方式说明

### ✅ 直接引用
高德 trafficLightStatus 和 CarrotMan traffic_state 值相同，直接传递使用：
- **-1**: 无效/未知 → traffic_state=-1
- **0**: 关闭/无信号 → traffic_state=0
- **1**: 红灯 → traffic_state=1

### 🔄 条件映射
根据方向信息（direction）进行条件判断：
- **2**: 绿灯
  - 当 direction=1 (左转) 或 direction=3 (左转掉头) 时 → traffic_state=3 (左转绿灯)
  - 其他情况 → traffic_state=2 (绿灯)

### 🔄 映射
高德 trafficLightStatus 和 CarrotMan traffic_state 值不同，需要转换：
- **3**: 黄灯 → traffic_state=1 (红灯，黄灯视为红灯处理)
- **4**: 绿灯 → traffic_state=2 (绿灯)
- **else**: 其他未知 → traffic_state=0 (关闭)

---

## 交通红绿灯方向说明

### 高德 direction 字段含义

| direction | 描述 |
|----------|------|
| 0 | 直行黄灯 |
| 1 | 左转 |
| 2 | 右转 |
| 3 | 左转掉头 |
| 4 | 直行 |
| 5 | 右转掉头 |
| else | 方向$direction |

### CarrotMan traffic_state 说明

| traffic_state | 描述 | 说明 |
|--------------|------|------|
| -1 | 无效 | 无效状态 |
| 0 | off | 关闭/无信号 |
| 1 | red | 红灯 |
| 2 | green | 绿灯 |
| 3 | left | 左转绿灯 |

---

## 特殊处理逻辑

### 1. 状态转换逻辑
当 traffic_state=0 (关闭) 且 leftSec <= 0 时：
- 如果之前的状态是 traffic_state=1 (红灯) 且 leftSec <= 3
- 则自动转换为 traffic_state=2 (绿灯)，leftSec=30
- **目的**: 避免红绿灯信号丢失导致的误判

### 2. 倒计时处理
- **红灯倒计时**: 当 trafficLightStatus=1, 3, 2, 4 时，使用 redLightCountDownSeconds
- **绿灯倒计时**: 使用 greenLightLastSecond

---

## 代码实现位置

### Android 端
- **文件**: `app/src/main/java/com/example/carrotamap/AmapTrafficHandlers.kt`
- **函数**: `mapTrafficLightStatus(amapStatus: Int, direction: Int = 0): Int` (第95-105行)
- **函数**: `handleTrafficLightInfo(intent: Intent)` (第282-338行)
- **函数**: `getTrafficLightDirectionDesc(direction: Int): String` (第107-117行)
- **说明**: 将高德地图交通红绿灯状态映射到 CarrotMan traffic_state

### Python 端
- **文件**: `carrot_serv.py`
- **变量**: `self.traffic_state` (第172行)
- **说明**: Python 端接收 traffic_state 值，用于交通灯状态显示和控制


---

# 高德地图车机版广播数据字段完整映射分析 (全量版)

根据 `app.log` 中 `KEY_TYPE: 10001` 的完整报文分析，高德广播包含以下子系统字段：

## 1. 核心导航与 ETA 字段
| 广播原始字段 | Log 示例值 | 映射到 Kotlin 字段 | 作用与逻辑描述 |
| :--- | :--- | :--- | :--- |
| `CUR_ROAD_NAME` | S58沪常高速 | `szPosRoadName` | 当前道路名。 |
| `NEXT_ROAD_NAME` | 北翟高架路 | `szNearDirName` | 转向后道路名。 |
| `NEXT_NEXT_ROAD_NAME` | null | `szFarDirName` | 备用远端参考。 |
| `LIMITED_SPEED` | 120 | `nRoadLimitSpeed` | 道路限速。代码中针对 40km/h 进行了 55km/h 的修正映射。 |
| `CUR_SPEED` | 480 | `xPosSpeed` | 实时车速。单位通常为 1/10 km/h。 |
| `CAR_DIRECTION` | 118 | `xPosAngle` | 车辆航向角。 |
| `ETA_TEXT` | 预计18:18到达 | - | UI 显示的预计到达时间字符串。 |
| `ROUTE_REMAIN_DIS` | 64402 | `nGoPosDist` | 距离终点总路程（米）。 |
| `ROUTE_REMAIN_TIME` | 4401 | `nGoPosTime` | 距离终点总时间（秒）。 |
| `ROUTE_REMAIN_TIME_AUTO`| 1时13分 | - | 格式化的剩余时间，多用于界面文本。 |

## 2. 转向提示 (TBT) 与路口辅助
| 广播原始字段 | Log 示例值 | 映射到 Kotlin 字段 | 作用与逻辑描述 |
| :--- | :--- | :--- | :--- |
| `ICON` / `NEW_ICON` | 20 | `nTBTTurnType` | 转向代码。映射后作为 CarrotMan 转向指令。 |
| `SEG_REMAIN_DIS` | 40316 | `nTBTDist` | 距离本路段结束/转向点的距离。 |
| `SEG_REMAIN_TIME` | 1611 | - | 转弯剩余时间秒。 |
| `ROUNG_ABOUT_NUM`| 0 | - | **环岛出口**。注意高德原始包名存在拼写错误 `ROUNG`。 |
| `SEG_ASSISTANT_ACTION`| 25 | - | **辅助指令**。多用于表示汇入、靠左等微操。 |
| `EXIT_NAME_INFO` | null | - | 出口名称。 |
| `addIcon` | "" | - | 附加图标指令，通常关联路口放大图。 |

## 3. 电子眼与测速 (SDI)
| 广播原始字段 | Log 示例值 | 映射到 Kotlin 字段 | 作用与逻辑描述 |
| :--- | :--- | :--- | :--- |
| `CAMERA_TYPE` | -1 | `nSdiType` | 电子眼类型。具体映射见 `mapAmapCameraTypeToSdi`。 |
| `CAMERA_DIST` | -1 | `nSdiDist` | 电子眼距离。-1 表示前方无电子眼。 |
| `CAMERA_SPEED` | -1 | `nSdiSpeedLimit` | 该电子眼的限速要求。 |
| `cameraID` | 5557550 | - | 电子眼唯一 ID，用于数据去重。 |
| `cameraPenalty` | false | - | 标记该测速点是否扣分罚款。 |

## 4. 服务区与设施 (SAPA)
| 广播原始字段 | Log 示例值 | 映射到 Kotlin 字段 | 作用与逻辑描述 |
| :--- | :--- | :--- | :--- |
| `SAPA_NAME` | S26沪常...收费站 | `sapaName` | 下一个设施的名称。 |
| `SAPA_DIST` | 35119 | `sapaDist` | 距离最近设施的距离。 |
| `SAPA_TYPE` | 1 | `sapaType` | 设施类型（1表示常规服务区/收费站）。 |
| `NEXT_SAPA_NAME` | null | - | 再下一个服务区的名称预报。 |

## 5. 目的地 (POI) 信息
| 广播原始字段 | Log 示例值 | 映射到 Kotlin 字段 | 作用与逻辑描述 |
| :--- | :--- | :--- | :--- |
| `endPOIName` | 上海东方明珠 | `szGoalName` | 导航最终目标点名称。 |
| `endPOILatitude` | 31.2397 | `goalPosY` | 终点纬度。 |
| `endPOILongitude` | 121.4998 | `goalPosX` | 终点经度。 |
| `arrivePOIType` | 000000 | - | 终点类别编码。 |

## 6. 其他路况与全局字段
| 广播原始字段 | Log 示例值 | 映射到 Kotlin 字段 | 作用与逻辑描述 |
| :--- | :--- | :--- | :--- |
| `KEY_TYPE` | 10001 | `keyType` | 广播协议族标识。 |
| `TRAFFIC_LIGHT_NUM` | 0 | `traffic_light_count`| 当前道路路段包含的交通灯数。 |
| `routeRemainTrafficLightNum`| 2 | `routeRemainTrafficLightNum`| 整条路径剩余交通灯总数。 |
| `nextRoadNOAOrNot` | false | `nextRoadNOAOrNot` | 自动领航辅助（NOA）可用性标记。 |
| `CUR_SEG_NUM` | 15 | `curSegNum` | 当前所在规划路段的索引。 |

> **文档说明**：
> 1. 上述字段涵盖了从 `app.log` 提取的 100% 原始键值对。
> 2. 部分字段在 Kotlin 中被标记为 `-` 表示当前 CarrotMan 协议暂不需要或仅作为原始数据保留，未参与核心控制计算。

---

# Python 端 (carrot_man.py / carrot_serv.py) 核心数据字段分析

本文档逆向分析了 Python 端的两个核心组件，总结了系统运行中涉及的所有 JSON 数据字段，并按数据来源（手机 App 发送、Openpilot 获取、算法运算）进行了分类归并。

## 1. 手机 App 通过 JSON 发送到 Python 的字段
这些字段由手机端的 `CPlink`（或高德/Waze 插件）通过 UDP 端口 `7706` 以 JSON 格式推送到 Python 端。

| 字段名称 (Key) | 描述 | 备注 |
| :--- | :--- | :--- |
| `carrotIndex` | 数据同步索引 | 用于心跳和时序校验。 |
| `nRoadLimitSpeed` | 当前道路官方限速 | 会进行 120->115 等区域性修正映射。 |
| `nSdiType` / `nSdiDist` | 电子眼类型与距离 | 核心 SDI 系统数据。 |
| `nSdiSpeedLimit` | 前方测速点的限速值 | 用于计算减速曲线。 |
| `nSdiSection` / `nSdiBlockDist` | 区间测速详请 | 包含区间总长、平均速度要求。 |
| `nTBTDist` / `nTBTTurnType` | 转弯距离与转向代码 | TBT 引导的核心：左转、右转、环岛等。 |
| `szTBTMainText` | 转向路口主显示文字 | 如“向南塘江大桥方向”。 |
| `szNearDirName` / `szFarDirName` | 近端/远端道路名 | 用于界面显示和语音预报参考。 |
| `nGoPosDist` / `nGoPosTime` | 终点距离(m)与时长(s) | 整个行程的 ETA 统计。 |
| `vpPosPointLat` / `vpPosPointLon` | 手机导航投射坐标 | 导航软件报告的道路拟合坐标，用于位置同步。 |
| `nPosAngle` / `nPosSpeed` | 手机航向角与速度 | 用于在地图未对齐时修正车辆方位。 |
| `goalPosX` / `goalPosY` | 目的地经纬度 | 本次行程的终点坐标。 |
| `szGoalName` | 目的地名称 | 字符串，如“陆家嘴”。 |
| `roadcate` | 道路分类代码 | 0/1: 高速, 2+: 城市道路。 |
| `carrotCmd` / `carrotArg` | 远程指令与参数 | 如 `DISPLAY MAP`（切换显示模式）。 |

## 2. 从 Openpilot (Cereal 消息) 获取的字段
Python 脚本通过 `SubMaster` 订阅 Openpilot 内部总线消息，获取车辆感知和状态数据。

| 字段名称 (Source) | 描述 | 对应的 Python 变量 |
| :--- | :--- | :--- |
| `carState.vEgo` | 车辆当前真实速度(m/s) | `v_ego` |
| `carState.vCruise` | 车主设定的定速巡航速度 | `v_cruise_kph` |
| `carState.gasPressed` | 油门踏板是否踩下 | `gas_pressed` |
| `selfdriveState.active` | OP 是否处于开启(Engaged)状态 | `controls_active` |
| `longitudinalPlan.xState` | 纵向控制状态 (停止/跟车/巡航) | `xState` |
| `modelV2.meta.modelTurnSpeed`| OP 视觉模型预测的弯道限制速度 | `model_turn_speed` |
| `navRouteNavd.coordinates` | OP 自带地图路径点 | `navi_points` |
| `navInstruction` | OP 标准导航消息 | 用于手机未连接时的冗余导航提示。 |

## 3. Python 内部运算生成的字段 (Calculated)
这些字段不是直接输入的，而是经过 `carrot_man` 或 `carrot_serv` 内部算法处理后，用于控制车辆或反馈给 App。

| 字段名称 | 描述 | 计算逻辑简介 |
| :--- | :--- | :--- |
| `vturn_speed` | **弯道限速** | 基于地图经纬度路径点，通过 `LineString` 插值和曲率公式计算出的安全车速。 |
| `atc_desired` | **ATC 目标速度** | 根据 TBT 距离和动作类型（如急转弯），利用减速公式计算的实时目标速度。 |
| `desired_speed` | **最终目标限速** | **核心逻辑**：取 Cruise速度, SDI限速, ATC限速, Map限速, 模型限速之中的 **最小值**。 |
| `desiredSource` | **限速来源标记** | 记录哪个模块触发了当前的限速（如 "atc", "cam", "road", "vturn"）。 |
| `xSpdDist` (实时值) | **补偿后的电子眼距离** | 在手机未更新报文的间隙，利用车辆里程计 `delta_dist` 实时扣除行驶距离。 |
| `bearing` (补偿值) | **综合航向角** | 结合手机 GPS 航向与车辆传感器偏移（`bearing_offset`）出的高精度角度。 |
| `leftSec` | **秒表倒计时** | 基于当前车速和剩余距离，动态预估到达电子眼或路口的秒数。 |
| `trafficState` | **自定义信号灯状态** | 对视觉检测指令 `DETECT` 的过滤处理（红/绿/左转）。 |

## 数据流向总结
1.  **Phone -> Python (UDP JSON)**: 核心导航和电子眼数据包。
2.  **Openpilot -> Python (ZMQ)**: 车辆物理状态、感知数据、路径点。
3.  **Python -> Openpilot (ZMQ)**: 将 `desired_speed` 指令下发给控制端。
4.  **Python -> Phone (UDP JSON)**: 将包含车辆状态（`vEgo`, `xState`）的 `make_send_message` 报文回传给手机 App，用于仪表模拟。

---

# 导航领航辅助 (NOA) 功能增强与演进方案

基于 `app.log` 暴露的隐藏字段，以下是可以进一步提升 NOA（Navigate on Autopilot）战术表现的建议方案。

## 1. 战术换道决策 (Tactical Lane Change)
目前的换道多依赖视觉模型，加入高德的出口信息可实现“意图驱动”的换道。

| 利用字段 | 描述 | 应用场景逻辑 |
| :--- | :--- | :--- |
| `EXIT_DIRECTION_INFO` | 出口方向 (例如: "右侧") | **提前变道**：当距离出口 < 2.5km 时，若此字段为“右侧”，NOA 逻辑应主动将目标车道向右侧偏移，避免临近出口切不进去。 |
| `EXIT_NAME_INFO` | 出口具体名称 | **语音/UI 增强**：在 UI 上显示“准备驶向 [出口名]”，增加驾驶员对系统的信心。 |
| `laneInfoList` | 实时车道拓扑 | **车道级导航**：结合当前车道及推荐车道（Recommended），在 OP 屏幕上高亮正确的车道线。 |

## 2. 复杂场景鲁棒性 (Corner Case Handling)
针对环岛、分岔路等视觉模型高退化场景进行数据补偿。

| 利用字段 | 描述 | 应用场景逻辑 |
| :--- | :--- | :--- |
| `ROUNG_ABOUT_NUM` | 环岛驶出索引序号 | **环岛控制**：当进入环岛后，计数经过的出口，当计数等于该字段时，强制触发驶离指令。 |
| `SEG_ASSISTANT_ACTION`| 辅助动作指示 | **分叉路权重**：当遇到 V 型分叉口时，利用此字段（如“靠左行驶”）给视觉模型的路径预测增加一个强约束偏置。 |

## 3. 长途行驶与安全保障 (Safety & Service)
| 利用字段 | 描述 | 应用场景逻辑 |
| :--- | :--- | :--- |
| `SAPA_DIST` / `NAME` | 服务区距离与名称 | **主动休息建议**：若 OP 监测到驾驶员连续驾驶超过 3 小时，且前方 5km 内有 `SAPA`，播报“建议在 [服务区名] 休息”。 |
| `nextRoadNOAOrNot` | 下段道路 NOA 可用性| **平滑接管过渡**：下一段若不可用，进度条变红并震动提醒，而非到路口才突然退出控制。 |

## 4. 路径跟踪精度优化 (Precise Localization)
| 利用字段 | 描述 | 应用场景逻辑 |
| :--- | :--- | :--- |
| `CUR_SEG_NUM` | 当前规划段号 | **死算位移补偿**：在多层立交桥（GPS 信号差）时，利用段号和点号的进阶，通过里程计反推当前在导航规划路径上的精确位置。 |
| `CUR_POINT_NUM` | 当前段内点号 | 同上，实现“离散点映射”，而非单纯依赖经纬度。 |

## 5. 即将引入的高价值字段 (Future Scope)
建议在 `AmapBroadcastHandlers.kt` 中追加以下字段的解析并发送至 Python：
- **`nextNextAddIcon`**: 用于获取更远端（下下个动作）的图标，使控制曲线更平滑。
- **`viaPOIdistance`**: 若有途径点，可提前准备途径点的停车或靠边逻辑。
- **`routeRemainTrafficLightNum`**: 全程红绿灯预报，用于优化长途行驶的能耗策略。

---
> **结论**：高德广播数据不仅是显示的参考，更是 NOA 决策层的重要“先验知识库”。通过融合 `EXIT` 和 `SEGMENT` 字段，可以将目前的 L2 级辅助驾驶提升至更具预判性的 L2.5+ 水平。


